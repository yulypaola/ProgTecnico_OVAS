<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flip-PDF Local ‚Äî Cargar, Ver como Libro y Exportar ZIP</title>

<!-- Estilos base -->
<style>
  :root{
    --bg:#0b0f19; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
    --ring:rgba(255,255,255,.10); --btn:rgba(255,255,255,.08); --btn-bd:rgba(255,255,255,.18);
    --accent:#60a5fa;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,sans-serif}
  .shell{min-height:100%;display:flex;flex-direction:column}
  header{
    position:sticky;top:0;z-index:20;background:rgba(15,23,42,.88);backdrop-filter:blur(8px);
    border-bottom:1px solid var(--ring)
  }
  .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;padding:10px 14px}
  .brand{font-weight:800;letter-spacing:.3px;margin-right:auto}
  .right{display:flex;gap:8px;align-items:center}
  .btn{
    color:#fff;background:var(--btn);border:1px solid var(--btn-bd);
    padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600
  }
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .file{display:inline-flex;align-items:center;gap:8px}
  input[type="file"]{display:none}
  label.btn{cursor:pointer}
  .hint{color:var(--muted);font-size:12px}
  .range{accent-color:var(--accent)}
  main{flex:1;display:flex;align-items:center;justify-content:center;padding:16px}
  #book{
    position:relative;max-width:95vw;max-height:86vh;background:#111827;border-radius:16px;overflow:hidden;
    box-shadow:0 12px 34px rgba(0,0,0,.38), inset 0 1px 0 rgba(255,255,255,.03), inset 0 24px 48px rgba(0,0,0,.18)
  }
  #book::after{
    content:'';position:absolute;top:4%;bottom:4%;left:50%;width:3px;transform:translateX(-50%);
    background:linear-gradient(to bottom,transparent,rgba(0,0,0,.4),transparent);opacity:.25;pointer-events:none;filter:blur(.2px)
  }
  #book[data-mode="single"]::after{display:none}
  .loading{padding:24px;opacity:.85}
  footer{
    position:sticky;bottom:0;background:rgba(15,23,42,.88);backdrop-filter:blur(8px);
    border-top:1px solid var(--ring)
  }
  .controls{display:flex;gap:10px;align-items:center;justify-content:center;padding:10px 14px}
  #status{min-width:90px;text-align:center;color:var(--muted);font-weight:700}
  #prog{height:6px;background:#0b1220;border:1px solid var(--ring);border-radius:999px;overflow:hidden}
  #prog>span{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#a78bfa);width:0%}
  .kbd{font:600 12px/1 monospace;color:#cbd5e1;border:1px solid var(--ring);padding:2px 6px;border-radius:6px}
</style>

<!-- Librer√≠as (CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2kDEe57..."
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/4.1.0/turn.min.js" integrity="sha512-9vHq..."
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.min.js" integrity="sha512-2rC5..."
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  // worker para PDF.js
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.worker.min.js";
</script>

<!-- Zip & Save -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-5gQy..."
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" integrity="sha512-bG6d..."
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
<div class="shell">
  <header>
    <div class="bar">
      <div class="brand">Flip-PDF Local</div>
      <div class="file">
        <input id="pdfFile" type="file" accept="application/pdf" />
        <label for="pdfFile" class="btn">üìÑ Cargar PDF</label>
        <span id="fileName" class="hint"></span>
      </div>

      <div class="right">
        <label class="hint">Resoluci√≥n:
          <input id="scale" class="range" type="range" min="0.8" max="2.5" step="0.1" value="1.4" />
        </label>
        <button id="build" class="btn" disabled>‚öôÔ∏è Renderizar</button>
        <button id="exportZip" class="btn" disabled>üíæ Exportar .zip</button>
      </div>
    </div>
    <div id="prog" aria-hidden="true"><span></span></div>
  </header>

  <main>
    <div id="book"><div class="loading">Carga un PDF y pulsa ‚ÄúRenderizar‚Äù.</div></div>
  </main>

  <footer>
    <div class="controls">
      <button id="prev" class="btn" disabled>‚óÄÔ∏é</button>
      <span id="status">‚Äì / ‚Äì</span>
      <button id="next" class="btn" disabled>‚ñ∂Ô∏é</button>
      <button id="auto" class="btn" disabled>Auto ‚ñ∑</button>
      <span class="hint">Atajos: <span class="kbd">‚Üê</span> / <span class="kbd">‚Üí</span>, clic izquierda/derecha</span>
    </div>
  </footer>
</div>

<script>
(() => {
  const $book = document.getElementById('book');
  const $file = document.getElementById('pdfFile');
  const $fileName = document.getElementById('fileName');
  const $build = document.getElementById('build');
  const $exportZip = document.getElementById('exportZip');
  const $scale = document.getElementById('scale');
  const $prev = document.getElementById('prev');
  const $next = document.getElementById('next');
  const $status = document.getElementById('status');
  const $auto = document.getElementById('auto');
  const $prog = document.getElementById('prog');
  const $bar = $prog.querySelector('span');

  let pdfArrayBuffer = null;
  let pagesDataURLs = []; // data URLs de las p√°ginas renderizadas
  let titleForZip = 'flip_book';

  // Cargar PDF
  $file.addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    titleForZip = (f.name || 'flip_book').replace(/\.pdf$/i,'').replace(/[^\w\-]+/g,'_');
    $fileName.textContent = f.name;
    pdfArrayBuffer = await f.arrayBuffer();
    $build.disabled = false;
    $exportZip.disabled = true;
    $status.textContent = '‚Äì / ‚Äì';
    $book.innerHTML = '<div class="loading">Listo para renderizar‚Ä¶</div>';
  });

  // Renderizar PDF -> im√°genes + flipbook
  $build.addEventListener('click', async () => {
    if (!pdfArrayBuffer) return;
    disableNav(true);
    $exportZip.disabled = true;
    pagesDataURLs = [];
    $book.innerHTML = '<div class="loading">Preparando‚Ä¶</div>';
    showProgress(0);

    try {
      const pdf = await pdfjsLib.getDocument({data: pdfArrayBuffer}).promise;
      const total = pdf.numPages;
      const scale = parseFloat($scale.value); // factor de resoluci√≥n

      for (let p = 1; p <= total; p++) {
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({scale});
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', {alpha:false});
        canvas.width  = viewport.width;
        canvas.height = viewport.height;
        await page.render({canvasContext: ctx, viewport}).promise;

        // WEBP suele comprimir mejor; fallback a PNG si el navegador no soporta
        let dataUrl;
        try { dataUrl = canvas.toDataURL('image/webp', 0.92); }
        catch { dataUrl = canvas.toDataURL('image/png'); }

        pagesDataURLs.push(dataUrl);
        showProgress(Math.round(p*100/total));
      }

      mountFlipbook(pagesDataURLs);
      $exportZip.disabled = false;
    } catch (err) {
      console.error(err);
      alert('No pude renderizar el PDF. Ver consola para m√°s detalles.');
      $book.innerHTML = '<div class="loading">Ocurri√≥ un error. Intenta con otro PDF.</div>';
    } finally {
      showProgress(null);
    }
  });

  function showProgress(percent){
    if (percent === null){
      $prog.setAttribute('aria-hidden','true');
      $bar.style.width = '0%';
    } else {
      $prog.removeAttribute('aria-hidden');
      $bar.style.width = percent + '%';
    }
  }

  // Inicializar flipbook con turn.js
  function mountFlipbook(imgs){
    $book.innerHTML = '';
    imgs.forEach((url, idx) => {
      const page = document.createElement('div');
      if (idx === 0 || idx === imgs.length - 1) page.className = 'hard';
      const img = document.createElement('img');
      img.src = url; img.alt = 'P√°gina ' + (idx+1);
      img.style.width='100%'; img.style.height='100%'; img.style.objectFit='contain';
      img.draggable = false;
      page.appendChild(img);
      $book.appendChild(page);
    });

    const $ = window.jQuery;
    const ratioPromise = new Promise((res)=>{
      const t = new Image();
      t.onload = ()=>res(t.naturalHeight / t.naturalWidth);
      t.src = imgs[0];
    });

    ratioPromise.then((ratio)=>{
      const isMobile = () => window.innerWidth < 992;
      const maxBookW = () => Math.min(window.innerWidth * 0.95, 1400);
      const compute = () => {
        const maxW = maxBookW();
        const footerH = 64;
        const availableH = Math.max(220, window.innerHeight - 140 - footerH);
        const maxPageWByWidth = isMobile() ? maxW : Math.floor(maxW / 2);
        const maxPageWByHeight = Math.round(availableH / ratio);
        const pageWidth = Math.max(220, Math.min(maxPageWByWidth, maxPageWByHeight));
        const bookWidth = isMobile() ? pageWidth : pageWidth * 2;
        const bookHeight = Math.round(pageWidth * ratio);
        return {bookWidth, bookHeight};
      };

      const s0 = compute();
      $($book).turn({
        width: s0.bookWidth, height: s0.bookHeight,
        display: isMobile() ? 'single' : 'double',
        autoCenter: true, acceleration: true, elevation: 80,
        turnCorners: 'bl,br,tl,tr', duration: 800, gradients: true
      });
      $book.setAttribute('data-mode', window.innerWidth < 992 ? 'single' : 'double');

      const onResize = () => {
        const s = compute();
        try { $($book).turn('display', window.innerWidth < 992 ? 'single' : 'double'); } catch {}
        try { $($book).turn('size', s.bookWidth, s.bookHeight); } catch {}
        try { $($book).turn('center'); } catch {}
        $book.setAttribute('data-mode', window.innerWidth < 992 ? 'single' : 'double');
        updateStatus();
      };
      window.addEventListener('resize', onResize);
      window.addEventListener('orientationchange', onResize);

      // Controles
      function updateStatus(){
        const c = $($book).turn('page') || 1;
        $status.textContent = c + ' / ' + imgs.length;
        $prev.disabled = c <= 1;
        $next.disabled = c >= imgs.length;
        $auto.disabled = false;
      }
      $($book).bind('turned', updateStatus);
      updateStatus();

      $prev.onclick = () => $($book).turn('previous');
      $next.onclick = () => $($book).turn('next');

      // click en zonas izquierda/derecha
      $book.addEventListener('click',(e)=>{
        const r = $book.getBoundingClientRect();
        const x = e.clientX - r.left;
        if (x < r.width/2) $($book).turn('previous'); else $($book).turn('next');
      });

      // teclado
      window.addEventListener('keydown',(e)=>{
        if (e.key === 'ArrowLeft') { e.preventDefault(); $($book).turn('previous'); }
        if (e.key === 'ArrowRight'){ e.preventDefault(); $($book).turn('next'); }
      });

      // auto-pase
      let timer=null;
      function startAuto(){
        stopAuto();
        timer = setInterval(()=>{
          const p = $($book).turn('page');
          if (p >= imgs.length) { stopAuto(); return; }
          $($book).turn('next');
        }, 4500);
        $auto.textContent = 'Auto ‚è∏';
      }
      function stopAuto(){ if (timer){ clearInterval(timer); timer=null; $auto.textContent='Auto ‚ñ∑'; } }
      $auto.onclick = ()=> timer ? stopAuto() : startAuto();
      ['click','keydown','wheel','touchstart','pointerdown'].forEach(ev=>{
        $book.addEventListener(ev, ()=>{ if (timer) stopAuto(); }, {passive:true});
      });

      // habilitar botones principales
      disableNav(false);
    });
  }

  function disableNav(flag){
    [$prev,$next,$auto].forEach(b=> b.disabled = flag);
  }

  // Exportar ZIP listo para subir
  $exportZip.addEventListener('click', async ()=>{
    if (!pagesDataURLs.length) return;
    const zip = new JSZip();
    const folder = `${titleForZip}`;
    const imgFolder = zip.folder(`${folder}/images`);

    // Agregar im√°genes
    for (let i=0;i<pagesDataURLs.length;i++){
      const dataUrl = pagesDataURLs[i];
      const base64 = dataUrl.split(',')[1];
      const ext = dataUrl.startsWith('data:image/png') ? 'png' : 'webp';
      imgFolder.file(`page-${i+1}.${ext}`, base64, {base64:true});
    }

    // index.html minimal para desplegar
    const ext = pagesDataURLs[0].startsWith('data:image/png') ? 'png' : 'webp';
    const pagesList = Array.from({length: pagesDataURLs.length}, (_,i)=>`"images/page-${i+1}.${ext}"`).join(',');
    const indexHtml =
`<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>${titleForZip} ‚Äî Flipbook</title>
<link rel="preload" as="image" href="./images/page-1.${ext}">
<style>
  html,body{height:100%;margin:0;background:#0b0f19;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{display:flex;align-items:center;justify-content:center;height:100%;padding:16px;box-sizing:border-box}
  #book{position:relative;max-width:95vw;max-height:90vh;background:#111827;border-radius:16px;overflow:hidden;
        box-shadow:0 12px 34px rgba(0,0,0,.38), inset 0 1px 0 rgba(255,255,255,.03), inset 0 24px 48px rgba(0,0,0,.18)}
  #book::after{content:'';position:absolute;top:4%;bottom:4%;left:50%;width:3px;transform:translateX(-50%);
               background:linear-gradient(to bottom,transparent,rgba(0,0,0,.4),transparent);opacity:.25;pointer-events:none}
  #book[data-mode="single"]::after{display:none}
  .controls{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:10px;background:rgba(15,23,42,.92);
            padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.08)}
  .btn{color:#fff;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);padding:6px 10px;border-radius:10px;cursor:pointer}
  #status{min-width:80px;text-align:center;color:#94a3b8;font-weight:700}
</style>
</head>
<body>
<div class="wrap"><div id="book"><div style="padding:18px;opacity:.8">Cargando‚Ä¶</div></div></div>
<div class="controls">
  <button id="prev" class="btn">‚óÄÔ∏é</button><span id="status">‚Äì/‚Äì</span><button id="next" class="btn">‚ñ∂Ô∏é</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/4.1.0/turn.min.js"></script>
<script>
const imgs=[${pagesList}];
(function(){
  const book = document.getElementById('book');
  book.innerHTML='';
  imgs.forEach((src,idx)=>{
    const p=document.createElement('div');
    if(idx===0||idx===imgs.length-1)p.className='hard';
    const i=new Image(); i.src=src; i.alt=''; i.style.width='100%'; i.style.height='100%'; i.style.objectFit='contain';
    p.appendChild(i); book.appendChild(p);
  });
  const isMobile=()=>window.innerWidth<992;
  const ratioPromise=new Promise(res=>{const t=new Image();t.onload=()=>res(t.naturalHeight/t.naturalWidth);t.src=imgs[0]});
  ratioPromise.then(ratio=>{
    const compute=()=>{
      const maxW=Math.min(window.innerWidth*.95,1400);
      const availH=Math.max(220, window.innerHeight-120);
      const maxByW=isMobile()?maxW:Math.floor(maxW/2);
      const maxByH=Math.round(availH/ratio);
      const pw=Math.max(220, Math.min(maxByW,maxByH));
      return {w:isMobile()?pw:pw*2,h:Math.round(pw*ratio)};
    };
    const s=compute();
    $(book).turn({width:s.w,height:s.h,display:isMobile()?'single':'double',autoCenter:true,elevation:80,acceleration:true,duration:800,turnCorners:'bl,br,tl,tr'});
    book.setAttribute('data-mode', isMobile()?'single':'double');
    const prev=document.getElementById('prev'), next=document.getElementById('next'), status=document.getElementById('status');
    function u(){ const c=$(book).turn('page'); status.textContent=c+' / '+imgs.length; prev.disabled=c<=1; next.disabled=c>=imgs.length; }
    u(); $(book).bind('turned',u);
    prev.onclick=()=>$(book).turn('previous'); next.onclick=()=>$(book).turn('next');
    window.addEventListener('resize',()=>{const s2=compute(); try{$(book).turn('display',isMobile()?'single':'double');}catch{} try{$(book).turn('size',s2.w,s2.h);}catch{} try{$(book).turn('center');}catch{} book.setAttribute('data-mode', isMobile()?'single':'double'); u();});
    book.addEventListener('click',(e)=>{const r=book.getBoundingClientRect(); const x=e.clientX-r.left; if(x<r.width/2)$(book).turn('previous'); else $(book).turn('next');});
    window.addEventListener('keydown',(e)=>{if(e.key==='ArrowLeft'){e.preventDefault();$(book).turn('previous');} if(e.key==='ArrowRight'){e.preventDefault();$(book).turn('next');}});
  });
})();
</script>
</body></html>`;

    // README
    const readme =
`# ${titleForZip}
Este paquete fue generado por Flip-PDF Local.
C√≥mo usar:
1) Sube la carpeta "${titleForZip}" completa a tu servidor (o abre "index.html").
2) Aseg√∫rate de tener internet para cargar las librer√≠as de CDN (jQuery/turn.js).
3) Las p√°ginas est√°n en /images.`;

    zip.file(`${folder}/index.html`, indexHtml);
    zip.file(`${folder}/README.txt`, readme);

    const blob = await zip.generateAsync({type:'blob', compression:'DEFLATE'});
    saveAs(blob, `${titleForZip}.zip`);
  });

})();
</script>
</body>
</html>
